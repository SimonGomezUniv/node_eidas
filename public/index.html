

<!doctype html>
<html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EIDAS Photo Demo</title>
    <link  rel="stylesheet"  href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <meta http-equiv="Content-Language" content="en">
    <script src="/json2list.js"></script>
    <link rel="icon" href="/logo.png" type="image/png">
</head>
<body>
    <div id="websocket-status-banner" style="display: none; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; padding: 10px; text-align: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; box-sizing: border-box;">
        <!-- Warning message will be inserted here by JavaScript -->
    </div>
    <main class="container">
        <h1>EIDAS Photo Demo</h1>
        <p>Scan the QR code with your wallet to get the photo.</p>
        <p>Click the button to launch the wallet.</p>
    
        <select id="options">
            <option value="photo">Photo</option>
            <option value="name">Name</option>
            <option value="mail">Mail</option>
        </select>
        <!-- Removed autofetch checkbox and its fieldset -->
        <div id="debug" style="display: none;">
            <h2>Debug</h2>
            <input  id="input" id="input" placeholder="Type something..." />
            
            <button onclick="generateQrcode()">generate qrcode </button>
            <button onclick="resetPhoto()">reset Photo</button>
            <button onclick="updateAppLink()">Update Link</button>
            
        </div>
        <br />
        <button class="secondary" onclick="debug()">Debug</button>
        <br />
        <br />
        <button id="wallet">launch Wallet </button>
        <div id="qr-code"></div>
        <div id="photo"></div>

        <hr> <!-- Adding a horizontal rule for separation -->

        <!-- Old loadDataButton and display areas removed -->

        <div id="vc-presentation-results" style="margin-top: 20px;">
            <div id="formatted-vc-display" style="border: 1px solid #ade; padding: 10px; margin-bottom: 10px;">
                <h3>Verifiable Credential Data</h3>
                <p><em>Waiting for data via WebSocket...</em></p>
            </div>
            <div id="technical-info-display" style="border: 1px solid #eda; padding: 10px;">
                <h3>Technical Analysis & Logs</h3>
                <pre><em>Waiting for data via WebSocket...</em></pre>
            </div>
        </div>
    </main>
</body>

<script>

    var dns_rp="http://192.168.1.19:3000"
    var nounce="random_string"
function debug(){
    const debugDiv = document.getElementById('debug');
    if (debugDiv.style.display === 'none') {
        debugDiv.style.display = 'block';
    } else {
        debugDiv.style.display = 'none';
    }
}

    function resetPhoto() {
        fetch('/reset-photo')
            .then(response => response.text())
            .then(html => {
                const photoDiv = document.getElementById('photo');
                photoDiv.innerHTML = html;
            })
            .catch(error => {
                console.error('Error resetting photo:', error);
            });
    }


    function updateAppLink(){
        qr_code_redirect = document.getElementById("input").value;
        document.getElementById("wallet").onclick = function() {
                window.open(qr_code_redirect, '_blank');
            };
    }

    function generateCodeFromRp(){

        fetch('/dns_rp')
        .then(response => response.json())
        .then(data => {
            dns_rp = data.dns_rp;
            nounce=document.getElementById("options").value+Math.floor(100000 + Math.random() * 900000)
            qr_code_redirect = `openid4vp://?client_id=my_client_id&request_uri=${dns_rp}/request-object/${nounce}`;
            document.getElementById("wallet").onclick = function() {
                window.open(qr_code_redirect, '_blank');
            };
            document.getElementById("input").value = qr_code_redirect;
            generateQrcode();
        })
        .catch(error => {
            console.error('Error fetching dns_rp:', error);
        });
    }
    
    generateCodeFromRp();
    document.getElementById("options").addEventListener("change", function() {
        nounce=document.getElementById("options").value+Math.floor(100000 + Math.random() * 900000)
        qr_code_redirect = `openid4vp://?client_id=my_client_id&request_uri=${dns_rp}/request-object/${nounce}`;
        document.getElementById("input").value = qr_code_redirect;
        generateQrcode();
    });

    function generateQrcode() {
        const inputValue = document.getElementById("input").value;
        fetch('/generate-qrcode', {
            method: 'POST',
            headers: {
            'Content-Type': 'application/json'
            },
            body: JSON.stringify({ text: inputValue })
        })
        .then(response => response.json())
        .then(data => {
            console.log('QR Code generated:', data);
            
            document.getElementById('qr-code').innerHTML = `<img src="${data.qrCode}" alt="QR Code" />`;
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }


    // Old fetchPhoto, loadData, and toggleFetchingPhoto functions are removed as they are obsolete.

    document.addEventListener('DOMContentLoaded', () => {
        const formattedVcArea = document.getElementById('formatted-vc-display');
        const technicalInfoPre = document.querySelector('#technical-info-display pre');
        
        // Determine WebSocket protocol and host
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}`;
        const socket = new WebSocket(wsUrl);

        function displayVcUpdate(payload) {
            console.log("Displaying VC_DATA_UPDATE:", payload);
            // Populate #formatted-vc-display
            formattedVcArea.innerHTML = '<h3>Verifiable Credential Data</h3>'; // Reset heading
            if (payload.formattedVcData && payload.formattedVcData.claims) {
                if (payload.formattedVcData.claims.length === 0) {
                    formattedVcArea.innerHTML += '<p><em>No claims found in the credential.</em></p>';
                }
                payload.formattedVcData.claims.forEach(claim => {
                    if (claim.type === 'image' && claim.value) {
                        const img = document.createElement('img');
                        img.src = claim.value;
                        img.alt = claim.label || 'Credential Image';
                        img.style.maxWidth = '200px'; // Max width for display
                        img.style.height = 'auto';
                        img.style.marginBottom = '10px';
                        img.style.display = 'block';
                        formattedVcArea.appendChild(img);
                    } else if (claim.type === 'text' && claim.value !== undefined) {
                        const p = document.createElement('p');
                        p.innerHTML = `<strong>${claim.label || 'Claim'}:</strong> ${escapeHtml(String(claim.value))}`;
                        formattedVcArea.appendChild(p);
                    } else {
                        console.warn("Skipping claim due to missing value or unknown type:", claim);
                    }
                });
            } else {
                formattedVcArea.innerHTML += '<p><em>No formatted claims data received.</em></p>';
            }
             // Add overall status to formattedVcArea
            const statusP = document.createElement('p');
            statusP.innerHTML = `<strong>Overall Status:</strong> ${escapeHtml(payload.status || 'N/A')}`;
            formattedVcArea.appendChild(statusP);


            // Populate #technical-info-display
            technicalInfoPre.textContent = JSON.stringify(payload.technicalDebugData, null, 2);
        }

        function displayProcessingError(payload) {
            console.log("Displaying PROCESSING_ERROR:", payload);
            formattedVcArea.innerHTML = `<h3>Processing Error</h3>
                                         <p><strong>Error:</strong> ${escapeHtml(payload.error || 'Unknown error')}</p>
                                         <p><strong>Status:</strong> ${escapeHtml(payload.status || 'N/A')}</p>`;
            technicalInfoPre.textContent = JSON.stringify(payload.details, null, 2);
        }

        function resetDisplayAreas(payload) {
            console.log("Displaying VC_DATA_RESET:", payload);
            const message = payload.message || "Waiting for data via WebSocket...";
            formattedVcArea.innerHTML = `<h3>Verifiable Credential Data</h3><p><em>${escapeHtml(message)}</em></p>`;
            technicalInfoPre.textContent = escapeHtml(message);
        }

        function escapeHtml(unsafe) {
            if (unsafe === null || unsafe === undefined) return '';
            return String(unsafe)
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }

        socket.onopen = () => {
            console.log('WebSocket connection established.');
            const banner = document.getElementById('websocket-status-banner');
            if (banner) {
                banner.style.display = 'none'; // Hide the warning banner
            }

            // formattedVcArea and technicalInfoPre are already defined in the outer scope
            if (formattedVcArea) {
                // Set initial message, keeping the H3 for structure consistency
                formattedVcArea.innerHTML = '<h3>Verifiable Credential Data</h3><p><em>WebSocket connecté. En attente de données...</em></p>';
            }
            if (technicalInfoPre) {
                technicalInfoPre.textContent = 'WebSocket connecté. En attente de données...';
            }
        };

        socket.onmessage = (event) => {
            try {
                const message = JSON.parse(event.data);
                console.log('WebSocket message received:', message);

                if (message.type === 'VC_DATA_UPDATE') {
                    displayVcUpdate(message.payload);
                } else if (message.type === 'PROCESSING_ERROR') {
                    displayProcessingError(message.payload);
                } else if (message.type === 'VC_DATA_RESET') {
                    resetDisplayAreas(message.payload);
                } else {
                    console.warn('Unknown WebSocket message type:', message.type);
                    technicalInfoPre.textContent = `Received unknown message type: ${message.type}`;
                }
            } catch (e) {
                console.error('Error processing WebSocket message:', e);
                technicalInfoPre.textContent = `Error processing message from server: ${e.message}`;
            }
        };

        socket.onerror = (error) => {
            console.error('WebSocket error:', error);
            formattedVcArea.innerHTML = '<h3>Verifiable Credential Data</h3><p><em>WebSocket connection error. See console for details.</em></p>';
            technicalInfoPre.textContent = 'WebSocket connection error. See console for details.';
        };

        socket.onclose = (event) => { // Ensure 'event' is passed to access event.code
            console.log('WebSocket connection closed. Code:', event.code, 'Reason:', event.reason);
            const banner = document.getElementById('websocket-status-banner');
            if (banner) {
                banner.innerHTML = "Connexion WebSocket interrompue (Code: " + (event.code || 'N/A') + 
                                   "). Les données affichées peuvent ne plus être à jour. " +
                                   "Actualisez la page pour tenter de vous reconnecter.";
                banner.style.display = 'block';
            }

            // DO NOT CLEAR the main content areas. The lines below were removed/commented out:
            // formattedVcArea.innerHTML = `<h3>Verifiable Credential Data</h3><p><em>WebSocket disconnected. Code: ${event.code}. Please refresh.</em></p>`;
            // technicalInfoPre.textContent = `WebSocket disconnected. Code: ${event.code}. Please refresh.`;
        };
    });

</script>

</html>